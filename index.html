<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NetWeb 本地项目管理</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="app">
      <header class="top-bar">
        <div class="brand">
          <button class="brand-icon" id="brand-home" aria-label="返回主界面">NW</button>
          <div>
            <h1>NetWeb</h1>
            <p>数据网项目交付管理</p>
          </div>
        </div>
        <nav class="nav">
          <div class="nav-group">
            <button class="tab active" data-menu="project-menu">项目管理</button>
            <div class="nav-panel" id="project-menu">
              <button class="nav-item" data-action="new-project">新建项目</button>
              <button class="nav-item" data-action="project-ongoing">正在进行</button>
              <button class="nav-item" data-action="project-completed">已完成</button>
            </div>
          </div>
          <div class="nav-group">
            <button class="tab" data-menu="system-menu">系统管理</button>
            <div class="nav-panel" id="system-menu">
              <button class="nav-item" data-action="system-basic">基本设置</button>
              <button class="nav-item">安全管理</button>
              <button class="nav-item" data-action="system-logs">操作日志</button>
            </div>
          </div>
        </nav>
        <div class="actions">
          <button class="icon-button" id="version-button" aria-label="版本信息">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path
                d="M12 3.4c-4.8 0-8.6 3.8-8.6 8.6s3.8 8.6 8.6 8.6 8.6-3.8 8.6-8.6-3.8-8.6-8.6-8.6Zm0 4.2c.6 0 1 .5.9 1.1l-.6 5.2a.4.4 0 0 1-.8 0l-.6-5.2c-.1-.6.3-1.1.9-1.1Zm0 9.7a1.2 1.2 0 1 1 0-2.4 1.2 1.2 0 0 1 0 2.4Z"
              />
            </svg>
          </button>
          <div class="user-profile">
            <button class="icon-button user-icon-button" aria-label="用户">
              <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                <path
                  d="M12 12.5c2.4 0 4.4-2 4.4-4.4S14.4 3.7 12 3.7 7.6 5.7 7.6 8.1 9.6 12.5 12 12.5Zm0 2.1c-4 0-7.4 2.1-7.4 4.6 0 .7.6 1.1 1.3 1.1h12.2c.7 0 1.3-.4 1.3-1.1 0-2.5-3.4-4.6-7.4-4.6Z"
                />
              </svg>
            </button>
            <span class="user-name">Admin</span>
          </div>
          <button class="icon-button" id="mode-toggle" aria-label="明暗切换">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path
                d="M12 3.4a8.6 8.6 0 1 1-6.1 2.5 8.6 8.6 0 0 1 6.1-2.5Zm0 2a6.6 6.6 0 1 0 0 13.2V5.4Z"
              />
            </svg>
          </button>
          <button class="icon-button" id="theme-toggle" aria-label="主题切换">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path
                d="M5.4 6.1A1.7 1.7 0 0 1 7.1 4.4h9.8a1.7 1.7 0 0 1 1.7 1.7v9.8a1.7 1.7 0 0 1-1.7 1.7H7.1a1.7 1.7 0 0 1-1.7-1.7V6.1Zm1.9.6v8.6h9.3V6.7H7.3Zm2.1 6.9 2.4-3 1.9 2.2 1.4-1.6 1.8 2.4H9.4Z"
              />
            </svg>
          </button>
        </div>
      </header>

      <main class="layout">
        <aside class="sidebar">
          <div class="sidebar-header">
            <h2 id="project-name">项目名称</h2>
          </div>
          <div class="menu is-hidden" data-menu="home">
            <button class="menu-item" data-action="new-project">新建项目</button>
            <button class="menu-item" data-action="project-ongoing">正在进行</button>
            <button class="menu-item" data-action="project-completed">已完成</button>
          </div>
          <div class="menu is-hidden" data-menu="project-list"></div>
          <div class="menu is-hidden" data-menu="project">
            <button class="menu-item active" data-panel="topology-panel">站点拓扑</button>
            <button class="menu-item" data-panel="script-panel">脚本管理</button>
            <button class="menu-item" data-panel="other-panel">其他</button>
          </div>
          <div class="menu is-hidden" data-menu="system">
            <button class="menu-item active" data-panel="timeout-panel">超时时间</button>
            <button class="menu-item" data-panel="system-theme-panel">系统主题</button>
            <button class="menu-item" data-panel="system-log-panel">操作日志</button>
          </div>
          <button class="task-button" aria-label="任务日志">
            <span class="task-icon" aria-hidden="true">◎</span>
          </button>
        </aside>

        <section class="content">
          <div class="panel active" id="home-panel">
            <div class="home-header">
              <h2>项目管理</h2>
              <p>快速进入项目创建与项目列表</p>
            </div>
            <div class="home-grid">
              <button class="home-card" data-action="new-project">
                <span>新建项目</span>
              </button>
              <button class="home-card" data-action="project-ongoing">
                <span>正在进行</span>
              </button>
              <button class="home-card" data-action="project-completed">
                <span>已完成</span>
              </button>
            </div>
          </div>
          <div class="panel" id="topology-panel">
            <div class="content-header content-header--split">
              <div class="content-action-left">
                <button class="primary" id="site-upload-button">添加站点</button>
              </div>
              <h2 class="content-title">站点拓扑</h2>
              <div class="content-action-right">
                <button class="ghost" data-empty="true">导出拓扑</button>
              </div>
            </div>
            <div class="canvas">
              <div class="canvas-header">
                <h3>主内容区域</h3>
                <span>在此呈现站点拓扑与可视化配置</span>
              </div>
              <div class="canvas-body">
                <div class="placeholder">
                  <div class="placeholder-icon">◎</div>
                  <p>空白画布</p>
                  <span>拖拽设备与节点开始配置</span>
                </div>
              </div>
            </div>
          </div>
          <div class="panel" id="script-panel">
            <div class="empty-state">
              <div class="placeholder-icon">◎</div>
              <p>脚本管理视图</p>
              <span>选择左侧菜单以查看脚本内容</span>
            </div>
          </div>
          <div class="panel" id="other-panel">
            <div class="content-header">
              <div class="content-title-row">
                <h2 class="content-title">其他</h2>
              </div>
            </div>
            <div class="settings-card">
              <div class="helper-text">可在此将项目标记为已完成。</div>
              <button class="primary" id="mark-complete-button">标记项目已完成</button>
            </div>
          </div>
          <div class="panel" id="timeout-panel">
            <div class="content-header">
              <h2 class="content-title">超时时间</h2>
            </div>
            <div class="settings-card">
              <label class="field">
                <span>超时时间（分钟）</span>
                <input type="number" value="999" min="1" />
              </label>
              <p class="helper-text">超时后将自动退出当前账号。</p>
            </div>
          </div>
          <div class="panel" id="system-theme-panel">
            <div class="content-header">
              <h2 class="content-title">系统主题</h2>
            </div>
            <div class="theme-settings">
              <section class="setting-section">
                <div class="setting-title">明暗调节</div>
                <div class="mode-switch" role="group" aria-label="明暗调节">
                  <button class="mode-chip" data-mode="light">明亮模式</button>
                  <button class="mode-chip" data-mode="dark">黑暗模式</button>
                </div>
              </section>
              <section class="setting-section">
                <div class="setting-title">主题调节</div>
                <div class="theme-grid" id="theme-grid"></div>
              </section>
            </div>
          </div>
          <div class="panel" id="system-log-panel">
            <div class="content-header">
              <h2 class="content-title">操作日志</h2>
            </div>
            <div class="task-table log-table" id="system-log-list" role="table" aria-label="操作日志">
              <div class="task-row task-header" role="row">
                <span role="columnheader">操作内容</span>
                <span role="columnheader">时间</span>
              </div>
            </div>
          </div>
          <div class="panel" id="project-list-panel">
            <div class="empty-state">
              <div class="placeholder-icon">◎</div>
              <p>选择左侧项目列表</p>
              <span>点击项目名称进入管理</span>
            </div>
          </div>
        </section>
      </main>
    </div>

    <div class="modal task-popover" id="task-modal" aria-hidden="true">
      <div class="modal-card task-card">
        <div class="modal-header">
          <h3>最近任务日志</h3>
          <button class="icon-button" data-close="task-modal" aria-label="关闭">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path
                d="M6.7 6.7a.8.8 0 0 1 1.1 0L12 11l4.2-4.3a.8.8 0 0 1 1.1 1.1L13.1 12l4.2 4.2a.8.8 0 0 1-1.1 1.1L12 13.1l-4.2 4.2a.8.8 0 0 1-1.1-1.1L10.9 12 6.7 7.8a.8.8 0 0 1 0-1.1Z"
              />
            </svg>
          </button>
        </div>
        <div class="task-table log-table" id="task-log-list" role="table" aria-label="最近任务">
          <div class="task-row task-header" role="row">
            <span role="columnheader">操作内容</span>
            <span role="columnheader">时间</span>
          </div>
        </div>
      </div>
    </div>
    <div class="toast" id="empty-toast" aria-hidden="true">无</div>

    <div class="modal version-modal" id="version-modal" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-header">
          <h3>版本信息</h3>
          <button class="icon-button" data-close="version-modal" aria-label="关闭">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path
                d="M6.7 6.7a.8.8 0 0 1 1.1 0L12 11l4.2-4.3a.8.8 0 0 1 1.1 1.1L13.1 12l4.2 4.2a.8.8 0 0 1-1.1 1.1L12 13.1l-4.2 4.2a.8.8 0 0 1-1.1-1.1L10.9 12 6.7 7.8a.8.8 0 0 1 0-1.1Z"
              />
            </svg>
          </button>
        </div>
        <p class="version-text">当前版本 0.1</p>
      </div>
    </div>

    <div class="modal" id="project-modal" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-header">
          <h3>新建项目</h3>
          <button class="icon-button" data-close="project-modal" aria-label="关闭">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path
                d="M6.7 6.7a.8.8 0 0 1 1.1 0L12 11l4.2-4.3a.8.8 0 0 1 1.1 1.1L13.1 12l4.2 4.2a.8.8 0 0 1-1.1 1.1L12 13.1l-4.2 4.2a.8.8 0 0 1-1.1-1.1L10.9 12 6.7 7.8a.8.8 0 0 1 0-1.1Z"
              />
            </svg>
          </button>
        </div>
        <label class="field">
          <span>项目名称</span>
          <input type="text" id="project-input" placeholder="请输入项目名称" />
        </label>
        <button class="primary" id="project-submit">创建</button>
      </div>
    </div>

    <div class="modal" id="site-modal" aria-hidden="true">
      <div class="modal-card">
        <div class="modal-header">
          <h3>上传站点信息</h3>
          <button class="icon-button" data-close="site-modal" aria-label="关闭">
            <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
              <path
                d="M6.7 6.7a.8.8 0 0 1 1.1 0L12 11l4.2-4.3a.8.8 0 0 1 1.1 1.1L13.1 12l4.2 4.2a.8.8 0 0 1-1.1 1.1L12 13.1l-4.2 4.2a.8.8 0 0 1-1.1-1.1L10.9 12 6.7 7.8a.8.8 0 0 1 0-1.1Z"
              />
            </svg>
          </button>
        </div>
        <label class="field">
          <span>选择本地文件（仅支持 Excel）</span>
          <input
            type="file"
            id="site-file"
            accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
          />
        </label>
        <div class="template-download">
          <span>站点互联信息模板</span>
          <a href="站点互联信息模板.xlsx" download>下载模板</a>
        </div>
        <button class="primary" id="site-upload-submit" disabled>上传</button>
      </div>
    </div>

    <script>
      const navTabs = document.querySelectorAll('.tab');
      const navPanels = document.querySelectorAll('.nav-panel');
      const menuItems = document.querySelectorAll('.menu-item');
      const menuGroups = document.querySelectorAll('.menu');
      const panels = document.querySelectorAll('.panel');
      const taskButton = document.querySelector('.task-button');
      const taskModal = document.getElementById('task-modal');
      const taskCard = taskModal.querySelector('.modal-card');
      const taskLogList = document.getElementById('task-log-list');
      const systemLogList = document.getElementById('system-log-list');
      const emptyToast = document.getElementById('empty-toast');
      const versionButton = document.getElementById('version-button');
      const versionModal = document.getElementById('version-modal');
      const projectModal = document.getElementById('project-modal');
      const projectInput = document.getElementById('project-input');
      const projectSubmit = document.getElementById('project-submit');
      const projectName = document.getElementById('project-name');
      const brandHome = document.getElementById('brand-home');
      const siteModal = document.getElementById('site-modal');
      const siteUploadButton = document.getElementById('site-upload-button');
      const siteFileInput = document.getElementById('site-file');
      const siteUploadSubmit = document.getElementById('site-upload-submit');
      const modeToggle = document.getElementById('mode-toggle');
      const themeToggle = document.getElementById('theme-toggle');
      const themeGrid = document.getElementById('theme-grid');
      const modeChips = document.querySelectorAll('.mode-chip');
      const markCompleteButton = document.getElementById('mark-complete-button');
      const projectListMenu = document.querySelector('[data-menu="project-list"]');
      const homeCards = document.querySelectorAll('.home-card');
      let toastTimer;
      let navCloseTimer;
      let activeProjectId = null;
      let activeProjectStatus = null;
      const storageKeys = {
        projects: 'netweb-projects',
        logs: 'netweb-logs',
      };

      const themePresets = [
        {
          name: '星河蓝',
          lightBackground:
            'radial-gradient(circle at top, #ffffff 0%, #e7f2ff 42%, #d2e7ff 100%)',
          darkBackground:
            'radial-gradient(circle at top, #192338 0%, #111827 48%, #0a0f1c 100%)',
          accent: '#1d6dff',
          accentSoft: 'rgba(29, 109, 255, 0.16)',
          brand: 'linear-gradient(135deg, #5ac8fa, #1d6dff)',
        },
        {
          name: '霞光橙',
          lightBackground:
            'radial-gradient(circle at top, #fff6ef 0%, #ffe2cc 45%, #ffd1b8 100%)',
          darkBackground:
            'radial-gradient(circle at top, #33211a 0%, #231610 48%, #120c08 100%)',
          accent: '#f97316',
          accentSoft: 'rgba(249, 115, 22, 0.18)',
          brand: 'linear-gradient(135deg, #ff9a62, #f97316)',
        },
        {
          name: '薄荷绿',
          lightBackground:
            'radial-gradient(circle at top, #f0fff7 0%, #d7f7e9 45%, #c0f0dd 100%)',
          darkBackground:
            'radial-gradient(circle at top, #1b2a24 0%, #101a16 48%, #0b1210 100%)',
          accent: '#14b8a6',
          accentSoft: 'rgba(20, 184, 166, 0.18)',
          brand: 'linear-gradient(135deg, #6ee7b7, #14b8a6)',
        },
        {
          name: '夜雾紫',
          lightBackground:
            'radial-gradient(circle at top, #f7f4ff 0%, #e3d9ff 45%, #d3c4ff 100%)',
          darkBackground:
            'radial-gradient(circle at top, #271a36 0%, #1a1324 48%, #120c18 100%)',
          accent: '#7c3aed',
          accentSoft: 'rgba(124, 58, 237, 0.18)',
          brand: 'linear-gradient(135deg, #c4b5fd, #7c3aed)',
        },
        {
          name: '晨曦粉',
          lightBackground:
            'radial-gradient(circle at top, #fff5f8 0%, #ffdbe7 45%, #ffc5d8 100%)',
          darkBackground:
            'radial-gradient(circle at top, #361a28 0%, #24111c 48%, #150b11 100%)',
          accent: '#ec4899',
          accentSoft: 'rgba(236, 72, 153, 0.18)',
          brand: 'linear-gradient(135deg, #f9a8d4, #ec4899)',
        },
        {
          name: '海盐青',
          lightBackground:
            'radial-gradient(circle at top, #f2ffff 0%, #d9f5f7 45%, #c2ebee 100%)',
          darkBackground:
            'radial-gradient(circle at top, #1b2a2c 0%, #111a1b 48%, #0a1011 100%)',
          accent: '#0ea5a4',
          accentSoft: 'rgba(14, 165, 164, 0.18)',
          brand: 'linear-gradient(135deg, #7dd3fc, #0ea5a4)',
        },
        {
          name: '金砂',
          lightBackground:
            'radial-gradient(circle at top, #fffaf0 0%, #ffe7c4 45%, #ffd89b 100%)',
          darkBackground:
            'radial-gradient(circle at top, #302512 0%, #1f170b 48%, #120d06 100%)',
          accent: '#f59e0b',
          accentSoft: 'rgba(245, 158, 11, 0.2)',
          brand: 'linear-gradient(135deg, #fcd34d, #f59e0b)',
        },
        {
          name: '暮霭灰蓝',
          lightBackground:
            'radial-gradient(circle at top, #f4f7ff 0%, #dfe7f5 45%, #cdd8ed 100%)',
          darkBackground:
            'radial-gradient(circle at top, #1a2334 0%, #111724 48%, #0a0f18 100%)',
          accent: '#3b82f6',
          accentSoft: 'rgba(59, 130, 246, 0.18)',
          brand: 'linear-gradient(135deg, #93c5fd, #3b82f6)',
        },
        {
          name: '琥珀茶',
          lightBackground:
            'radial-gradient(circle at top, #fff8f2 0%, #ffe3cf 45%, #ffd2b2 100%)',
          darkBackground:
            'radial-gradient(circle at top, #331c12 0%, #22130c 48%, #120a06 100%)',
          accent: '#ea580c',
          accentSoft: 'rgba(234, 88, 12, 0.18)',
          brand: 'linear-gradient(135deg, #fdba74, #ea580c)',
        },
        {
          name: '青黛',
          lightBackground:
            'radial-gradient(circle at top, #f4f7ff 0%, #d6e2ff 45%, #bdd1ff 100%)',
          darkBackground:
            'radial-gradient(circle at top, #151f37 0%, #0f172a 48%, #0a0f1a 100%)',
          accent: '#2563eb',
          accentSoft: 'rgba(37, 99, 235, 0.18)',
          brand: 'linear-gradient(135deg, #93c5fd, #2563eb)',
        },
      ];
      let currentThemeIndex = 0;

      const showToast = (message, anchor) => {
        if (!emptyToast) {
          return;
        }
        emptyToast.textContent = message;
        const rect = anchor.getBoundingClientRect();
        emptyToast.style.left = `${rect.left + rect.width / 2}px`;
        emptyToast.style.top = `${rect.bottom + 12}px`;
        emptyToast.classList.add('show');
        emptyToast.setAttribute('aria-hidden', 'false');
        window.clearTimeout(toastTimer);
        toastTimer = window.setTimeout(() => {
          emptyToast.classList.remove('show');
          emptyToast.setAttribute('aria-hidden', 'true');
        }, 1600);
      };

      const closeNavPanels = () => {
        navTabs.forEach((btn) => btn.classList.remove('active'));
        navPanels.forEach((panel) => panel.classList.remove('open'));
      };

      const showMenuGroup = (menuKey) => {
        menuGroups.forEach((menu) => {
          menu.classList.toggle('is-hidden', menu.dataset.menu !== menuKey);
        });
      };

      const showPanel = (panelId) => {
        panels.forEach((panel) => panel.classList.toggle('active', panel.id === panelId));
      };

      const setSidebarTitle = (title, isProjectName = false) => {
        projectName.textContent = title;
        projectName.classList.toggle('is-project', isProjectName);
      };

      const loadProjects = () => {
        try {
          const raw = localStorage.getItem(storageKeys.projects);
          return raw ? JSON.parse(raw) : [];
        } catch (error) {
          return [];
        }
      };

      const saveProjects = (items) => {
        localStorage.setItem(storageKeys.projects, JSON.stringify(items));
      };

      const loadLogs = () => {
        try {
          const raw = localStorage.getItem(storageKeys.logs);
          return raw ? JSON.parse(raw) : [];
        } catch (error) {
          return [];
        }
      };

      const saveLogs = (items) => {
        localStorage.setItem(storageKeys.logs, JSON.stringify(items));
      };

      let projects = loadProjects();
      let logs = loadLogs();

      const formatTime = (date = new Date()) => {
        return date.toLocaleTimeString('zh-CN', {
          hour: '2-digit',
          minute: '2-digit',
        });
      };

      const addLog = (message) => {
        const entry = {
          message,
          time: formatTime(),
        };
        logs = [entry, ...logs];
        saveLogs(logs);
        renderLogs();
      };

      const renderLogs = () => {
        const containers = [taskLogList, systemLogList].filter(Boolean);
        containers.forEach((container) => {
          container
            .querySelectorAll('.task-row:not(.task-header)')
            .forEach((row) => row.remove());
          if (!logs.length) {
            const emptyRow = document.createElement('div');
            emptyRow.className = 'task-row';
            emptyRow.innerHTML = `
              <span>暂无记录</span>
              <span>--</span>
            `;
            container.appendChild(emptyRow);
            return;
          }
          logs.forEach((entry) => {
            const row = document.createElement('div');
            row.className = 'task-row';
            row.innerHTML = `
              <span>${entry.message}</span>
              <span>${entry.time}</span>
            `;
            container.appendChild(row);
          });
        });
      };

      const showHome = () => {
        activeProjectId = null;
        activeProjectStatus = null;
        showMenuGroup('home');
        setSidebarTitle('项目管理', false);
        showPanel('home-panel');
      };

      const openProjectManagement = (project) => {
        if (!project) {
          return;
        }
        activeProjectId = project.id;
        activeProjectStatus = project.status;
        setSidebarTitle(project.name, true);
        showMenuGroup('project');
        showPanel('topology-panel');
        const defaultItem = document.querySelector('[data-menu="project"] .menu-item');
        if (defaultItem) {
          defaultItem
            .closest('.menu')
            .querySelectorAll('.menu-item')
            .forEach((button) => button.classList.toggle('active', button === defaultItem));
        }
      };

      const renderProjectList = (status) => {
        if (!projectListMenu) {
          return;
        }
        projectListMenu.innerHTML = '';
        const filtered = projects.filter((project) => project.status === status);
        filtered.forEach((project) => {
          const button = document.createElement('button');
          button.className = 'menu-item';
          button.textContent = project.name;
          button.addEventListener('click', () => {
            projectListMenu
              .querySelectorAll('.menu-item')
              .forEach((item) => item.classList.toggle('active', item === button));
            openProjectManagement(project);
          });
          projectListMenu.appendChild(button);
        });
      };

      const handleProjectStatus = (status, anchor) => {
        const filtered = projects.filter((project) => project.status === status);
        if (!filtered.length) {
          showToast('暂无项目', anchor);
          return;
        }
        activeProjectId = null;
        activeProjectStatus = status;
        setSidebarTitle('项目管理', false);
        showMenuGroup('project-list');
        showPanel('project-list-panel');
        renderProjectList(status);
      };

      const applyTheme = (theme) => {
        const root = document.documentElement;
        const isDarkMode = document.body.classList.contains('theme-dark');
        root.style.setProperty(
          '--page-bg',
          isDarkMode ? theme.darkBackground : theme.lightBackground,
        );
        root.style.setProperty('--accent', theme.accent);
        root.style.setProperty('--accent-soft', theme.accentSoft);
        root.style.setProperty('--brand-gradient', theme.brand);
      };

      const updateThemePreviews = () => {
        const isDarkMode = document.body.classList.contains('theme-dark');
        document.querySelectorAll('.theme-card').forEach((card) => {
          const index = Number(card.dataset.index);
          const theme = themePresets[index];
          card.style.setProperty(
            '--theme-preview',
            isDarkMode ? theme.darkBackground : theme.lightBackground,
          );
        });
      };

      const updateThemeSelection = () => {
        document.querySelectorAll('.theme-card').forEach((card) => {
          card.classList.toggle(
            'selected',
            Number(card.dataset.index) === currentThemeIndex,
          );
        });
      };

      const renderThemeCards = () => {
        if (!themeGrid) {
          return;
        }
        themeGrid.innerHTML = '';
        themePresets.forEach((theme, index) => {
          const card = document.createElement('button');
          card.type = 'button';
          card.className = 'theme-card';
          card.dataset.index = index;
          card.innerHTML = `
            <div class="theme-preview">
              <span>${theme.name}</span>
            </div>
          `;
          themeGrid.appendChild(card);
        });
        updateThemePreviews();
        updateThemeSelection();
      };

      const randomTheme = () => {
        let nextIndex = currentThemeIndex;
        while (nextIndex === currentThemeIndex) {
          nextIndex = Math.floor(Math.random() * themePresets.length);
        }
        currentThemeIndex = nextIndex;
        applyTheme(themePresets[currentThemeIndex]);
      };

      applyTheme(themePresets[currentThemeIndex]);
      renderThemeCards();

      navTabs.forEach((tab) => {
        const navGroup = tab.closest('.nav-group');
        const openPanel = () => {
          window.clearTimeout(navCloseTimer);
          const targetId = tab.dataset.menu;
          navTabs.forEach((btn) => btn.classList.toggle('active', btn === tab));
          navPanels.forEach((panel) => panel.classList.toggle('open', panel.id === targetId));
        };

        const scheduleClose = () => {
          window.clearTimeout(navCloseTimer);
          navCloseTimer = window.setTimeout(() => {
            closeNavPanels();
          }, 160);
        };

        tab.addEventListener('click', (event) => {
          event.stopPropagation();
          openPanel();
        });

        navGroup.addEventListener('mouseenter', openPanel);
        navGroup.addEventListener('mouseleave', scheduleClose);
      });

      menuItems.forEach((item) => {
        item.addEventListener('click', () => {
          const target = item.dataset.panel;
          if (!target) {
            return;
          }
          const parentMenu = item.closest('.menu');
          if (parentMenu) {
            parentMenu
              .querySelectorAll('.menu-item')
              .forEach((btn) => btn.classList.toggle('active', btn === item));
          }
          showPanel(target);
        });
      });

      taskButton.addEventListener('click', () => {
        taskModal.classList.add('open');
        taskModal.setAttribute('aria-hidden', 'false');
        window.requestAnimationFrame(() => {
          taskModal.classList.add('visible');
        });
        const rect = taskButton.getBoundingClientRect();
        const maxHeight = Math.min(window.innerHeight * 0.6, taskCard.scrollHeight);
        const cardWidth = Math.min(860, window.innerWidth - 48);
        const leftCandidate = rect.right + 16;
        const left = Math.min(
          Math.max(leftCandidate, 24),
          window.innerWidth - cardWidth - 24,
        );
        const top = Math.min(
          Math.max(rect.bottom - maxHeight, 24),
          window.innerHeight - maxHeight - 24,
        );
        taskCard.style.maxHeight = `${maxHeight}px`;
        taskCard.style.left = `${left}px`;
        taskCard.style.width = `${cardWidth}px`;
        taskCard.style.top = `${top}px`;
      });

      document.querySelectorAll('[data-close]').forEach((button) => {
        button.addEventListener('click', () => {
          const target = document.getElementById(button.dataset.close);
          target.classList.remove('open');
          target.classList.remove('visible');
          target.setAttribute('aria-hidden', 'true');
        });
      });

      versionButton.addEventListener('click', () => {
        versionModal.classList.add('open');
        versionModal.setAttribute('aria-hidden', 'false');
      });

      const handleAction = (action, anchor) => {
        if (action === 'new-project') {
          projectModal.classList.add('open');
          projectModal.setAttribute('aria-hidden', 'false');
          projectInput.value = '';
          projectInput.focus();
        } else if (action === 'project-ongoing') {
          handleProjectStatus('ongoing', anchor);
        } else if (action === 'project-completed') {
          handleProjectStatus('completed', anchor);
        } else if (action === 'system-basic') {
          showMenuGroup('system');
          showPanel('timeout-panel');
          const defaultItem = document.querySelector('[data-menu="system"] .menu-item');
          if (defaultItem) {
            defaultItem
              .closest('.menu')
              .querySelectorAll('.menu-item')
              .forEach((button) => button.classList.toggle('active', button === defaultItem));
          }
          setSidebarTitle('系统管理', false);
        } else if (action === 'system-logs') {
          showMenuGroup('system');
          showPanel('system-log-panel');
          const logItem = document.querySelector('[data-panel="system-log-panel"]');
          if (logItem) {
            logItem
              .closest('.menu')
              .querySelectorAll('.menu-item')
              .forEach((button) => button.classList.toggle('active', button === logItem));
          }
          setSidebarTitle('系统管理', false);
        } else {
          showToast('无', anchor);
        }
      };

      document.querySelectorAll('.nav-item').forEach((item) => {
        item.addEventListener('click', () => {
          const action = item.dataset.action;
          handleAction(action, item);
          closeNavPanels();
        });
      });

      projectSubmit.addEventListener('click', () => {
        const value = projectInput.value.trim();
        if (!value) {
          showToast('请输入项目名称', projectSubmit);
          return;
        }
        const newProject = {
          id: Date.now().toString(),
          name: value,
          status: 'ongoing',
          createdAt: new Date().toISOString(),
        };
        projects = [newProject, ...projects];
        saveProjects(projects);
        addLog(`创建项目：${value}`);
        projectModal.classList.remove('open');
        projectModal.setAttribute('aria-hidden', 'true');
        openProjectManagement(newProject);
      });

      siteUploadButton.addEventListener('click', () => {
        siteModal.classList.add('open');
        siteModal.setAttribute('aria-hidden', 'false');
        siteFileInput.value = '';
        siteUploadSubmit.disabled = true;
      });

      siteFileInput.addEventListener('change', () => {
        siteUploadSubmit.disabled = !siteFileInput.files.length;
      });

      siteUploadSubmit.addEventListener('click', () => {
        if (!siteFileInput.files.length) {
          return;
        }
        siteModal.classList.remove('open');
        siteModal.setAttribute('aria-hidden', 'true');
        showToast('站点信息已上传', siteUploadButton);
        addLog('添加站点信息');
      });

      modeToggle.addEventListener('click', () => {
        document.body.classList.toggle('theme-dark');
        applyTheme(themePresets[currentThemeIndex]);
        updateThemePreviews();
        modeChips.forEach((chip) => {
          const isDarkMode = document.body.classList.contains('theme-dark');
          chip.classList.toggle(
            'active',
            (chip.dataset.mode === 'dark' && isDarkMode) ||
              (chip.dataset.mode === 'light' && !isDarkMode),
          );
        });
      });

      themeToggle.addEventListener('click', () => {
        randomTheme();
        showToast('主题已切换', themeToggle);
        updateThemeSelection();
        updateThemePreviews();
      });

      if (themeGrid) {
        themeGrid.addEventListener('click', (event) => {
          const card = event.target.closest('.theme-card');
          if (!card) {
            return;
          }
          currentThemeIndex = Number(card.dataset.index);
          applyTheme(themePresets[currentThemeIndex]);
          updateThemeSelection();
          showToast('主题已切换', card);
        });
      }

      modeChips.forEach((chip) => {
        chip.addEventListener('click', () => {
          document.body.classList.toggle('theme-dark', chip.dataset.mode === 'dark');
          applyTheme(themePresets[currentThemeIndex]);
          updateThemePreviews();
          modeChips.forEach((item) => item.classList.toggle('active', item === chip));
        });
      });

      document.querySelectorAll('[data-empty="true"]').forEach((button) => {
        button.addEventListener('click', () => {
          showToast('无', button);
        });
      });

      homeCards.forEach((card) => {
        card.addEventListener('click', () => {
          handleAction(card.dataset.action, card);
        });
      });

      document.querySelectorAll('.menu-item[data-action]').forEach((item) => {
        item.addEventListener('click', () => {
          handleAction(item.dataset.action, item);
        });
      });

      if (brandHome) {
        brandHome.addEventListener('click', () => {
          showHome();
        });
      }

      if (markCompleteButton) {
        markCompleteButton.addEventListener('click', () => {
          if (!activeProjectId) {
            showToast('请先选择项目', markCompleteButton);
            return;
          }
          const project = projects.find((item) => item.id === activeProjectId);
          if (!project) {
            showToast('未找到项目', markCompleteButton);
            return;
          }
          if (project.status === 'completed') {
            showToast('项目已完成', markCompleteButton);
            return;
          }
          project.status = 'completed';
          projects = projects.map((item) => (item.id === project.id ? project : item));
          saveProjects(projects);
          addLog(`项目已完成：${project.name}`);
          showToast('项目已标记完成', markCompleteButton);
        });
      }

      window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
          event.target.classList.remove('open');
          event.target.classList.remove('visible');
          event.target.setAttribute('aria-hidden', 'true');
        } else if (!event.target.closest('.nav-panel') && !event.target.closest('.tab')) {
          closeNavPanels();
        }
      });

      window.addEventListener('resize', () => {
        taskModal.classList.remove('open');
        taskModal.classList.remove('visible');
        taskModal.setAttribute('aria-hidden', 'true');
      });

      modeChips.forEach((chip) => {
        const isDarkMode = document.body.classList.contains('theme-dark');
        chip.classList.toggle(
          'active',
          (chip.dataset.mode === 'dark' && isDarkMode) ||
            (chip.dataset.mode === 'light' && !isDarkMode),
        );
      });

      renderLogs();
      showHome();
    </script>
  </body>
</html>
